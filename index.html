<html>
    <head>
        <title>Viarail App</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <style>
            html {
                font-family: system-ui;
            }
            body {
                margin: auto;
                max-width: 320px;
                max-height: 720px;  
                padding: 8px;
            }
            header {
                font-size: larger;
                margin-top: 10vh;
                margin-bottom: 16px;
            }
            form label {
                display: block;
                margin-bottom: 4px;
            }
        </style>
    </head>
    <body>
        <header>How late will VIA Rail be?</header>
        <form id="criteria">
            <label>
                <span>Arrival Station</span>
                <select id="arrivalStation"></select>
            </label>
            <label>
                <span>Origin Station</span>
                <select id="originStation"></select>
            </label>
            <label>
                <span>Train Number</span>
                <select id="trainNumber"></select>
            </label>
        </form>
        <script type="module">
            /* Load data */

            const rawData = await fetch("data.csv")
                .then(res => {
                    if (res.status !== 200) console.error(res.body)
                    return res.text() || ""
                })
            const rows = rawData.split("\n").slice(1)

            const stations = {}
            const origins = {}
            const trainNumbers = new Set()
            const arrivals = []
            for (const row of rows) {
                if (!row) continue
                const [trainNumber, stationName, originName, date, expected, actual] = row.split(",")

                if (!stations[stationName]) {
                    const nextId = `${Object.keys(stations).length + 1}`
                    stations[stationName] = nextId
                }

                const stationId = stations[stationName]

                if (!origins[originName]) {
                    const nextId = `${Object.keys(origins).length + 1}`
                    origins[originName] = nextId
                }

                const originId = origins[originName]

                const arrival = {
                    trainNumber,
                    stationId,
                    originId,
                    date,
                    expected: Number(expected),
                    actual: Number(actual)
                }
                arrivals.push(arrival)
                trainNumbers.add(Number(trainNumber))
            }

            /* Add options to arrival input */

            const stationOptions = [
                ["*", "any"], 
                ...Object.entries(stations).map(([name, id]) => ([id, name]))
            ]

            const arrivalSelect = document.getElementById("arrivalStation")
            stationOptions.forEach(([stationId, stationName], i) => {
                arrivalSelect[i] = new Option(stationName, stationId)
            })

            /* Add options to origin input */

            const originOptions = [
                ["*", "any"],
                ...Object.entries(origins).map(([name, id]) => ([id, name]))
            ]

            const originSelect = document.getElementById("originStation")
            originOptions.forEach(([stationId, stationName], i) => {
                originSelect[i] = new Option(stationName, stationId)
            })

            /* Add options to train number input */

            const trainNumberOptions = [
                ["*", "any"],
                ...[...trainNumbers].sort().map(trainNumber => ([ trainNumber, trainNumber ]))
            ]

            const trainNumberSelect = document.getElementById("trainNumber")
            trainNumberOptions.forEach(([trainNumber, trainNumberName], i) => {
                trainNumberSelect[i] = new Option(trainNumberName || trainNumber, trainNumber)
            })

            /* Add event listener to form */

            function handleInputChange() {
                const arrivalStation = document.getElementById("arrivalStation").value
                const originStation = document.getElementById("originStation").value
                const trainNumber = document.getElementById("trainNumber").value

                displayStats(arrivalStation, originStation, trainNumber)
                // updateOptions(arrivalStation, originStation, trainNumber)
            }

            // function updateOptions (arrivalStation, originStation, trainNumber) {
            //     if (arrivalStation === "*") {
            //         // enable all options
            //         const originSelect = document.getElementById("originStation")
            //         originSelect.childNodes.forEach((option) => {
            //             option.disabled = false
            //         })
            //         const trainSelect = document.getElementById("trainNumber")
            //         trainSelect.childNodes.forEach((option) => {
            //             option.disabled = false
            //         })
            //         return
            //     }

            //     // Restrict origin station options for this arrival station
            //     const originResults = db.exec(`
            //         SELECT DISTINCT origin_id
            //         FROM arrival
            //         WHERE station_id = ${arrivalStation}
            //     `)
            //     const origins = originResults[0].values.map(([value]) => value)
            //     const originOptions = new Set(["*", ...origins])

            //     const originSelect = document.getElementById("originStation")
            //     originSelect.childNodes.forEach((option) => {
            //         option.disabled = !originOptions.has(Number(option.value))
            //     })

            //     // Reset origin if current option is now disabled
            //     if (originSelect.selectedOptions[0].disabled) {
            //         originSelect.value = "*"
            //     }
                
            //     // Restrict train number options for this arrival and origin station
            //     const originFilter = originStation === "*"
            //         ? `true`
            //         : `origin_id = ${originStation}`

            //     const trainNumberResults = db.exec(`
            //         SELECT DISTINCT train_number
            //         FROM arrival
            //         WHERE station_id = ${arrivalStation}
            //             AND ${originFilter}
            //     `)

            //     const trainNumbers = trainNumberResults[0].values.map(([value]) => value)
            //     const trainNumberOptions = new Set(["*", ...trainNumbers])

            //     const trainNumberSelect = document.getElementById("trainNumber")
            //     trainNumberSelect.childNodes.forEach((option) => {
            //         option.disabled = !trainNumberOptions.has(Number(option.value))
            //     })
            //     // Reset train number if current option is now disabled
            //     if (trainNumberSelect.selectedOptions[0].disabled) {
            //         trainNumberSelect.value = "*"
            //     }
            // }

            function displayStats (arrivalStation = "*", originStation = "*", trainNumber = "*") {

                console.log({ arrivalStation, originStation, trainNumber })

                const results = arrivals
                    .filter(({ stationId }) => arrivalStation === "*" || stationId === arrivalStation)
                    .filter(({ originId }) => originStation === "*" || originId === originStation)
                    .map(({ expected, actual }) => actual - expected)
                    .reduce(
                        (acc, cur) => {
                            if (cur > 15) acc.plus15++
                            if (cur > 60) acc.plus60++
                            acc.total++
                            return acc
                        },
                        { plus15: 0, plus60: 0, total: 0 })
                    // TODO - filter train number
                    
                const { plus15, plus60, total } = results

                const message = `
                    trains arrived <strong>15 minutes late</strong> ${plus15} times;<br>
                    trains arrived <strong>more than 1 hour late</strong> ${plus60} times;<br>
                    (out of ${total} total trains)
                `

                const el = document.createElement("div")
                el.innerHTML = message
                document.body.appendChild(el)
            }

            document.getElementById("criteria").addEventListener('change', e => handleInputChange())

            /* Add initial data to page */

            displayStats()
        </script>
    </body>
</html>
