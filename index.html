<html>
    <head>
        <title>Viarail App</title>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- <link rel="stylesheet" href="index.css"> -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.7.0/sql-wasm.js" integrity="sha512-vHGg41kMMVrI90EIvUSlrqyE0AOAzHJOxWSMZrv0FkSCLrRsXxfmDrSM/7ms3jINzUROn5OWAlWp+xx0tVdakw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <style>
            body {
                margin: auto;
                max-width: 1024px;
                max-height: 720px;
            }
            form label {
                display: block;
            }
        </style>
    </head>
    <body>
        <header>How late will VIA Rail be?</header>
        <form id="criteria">
            <label>
                <span>Arrival Station</span>
                <select id="arrivalStation"></select>
            </label>
            <label>
                <span>Origin Station</span>
                <select id="originStation"></select>
            </label>
            <label>
                <span>Train Number</span>
                <select id="trainNumber"></select>
            </label>
        </form>
        <script type="module">
            /* Load database */

            const sqlPromise = initSqlJs({
                locateFile: file => `https://sql.js.org/dist/${file}`
            });
            const dataPromise = fetch("mora.db").then(res => res.arrayBuffer());
            const [SQL, buf] = await Promise.all([sqlPromise, dataPromise])
            const db = new SQL.Database(new Uint8Array(buf));

            /* Add options to arrival input */

            const stationResults = db.exec("SELECT station_id, station_name FROM station")
            const stations = stationResults[0].values
            const stationOptions = [["*", "any"], ...stations]

            const arrivalSelect = document.getElementById("arrivalStation")
            stationOptions.forEach(([stationId, stationName], i) => {
                arrivalSelect[i] = new Option(stationName, stationId)
            })

            /* Add options to origin input */

            const originResults = db.exec("SELECT DISTINCT station.station_id, station_name FROM station JOIN arrival ON origin_id = station.station_id")
            const origins = originResults[0].values
            const originOptions = [["*", "any"], ...origins]

            const originSelect = document.getElementById("originStation")
            originOptions.forEach(([stationId, stationName], i) => {
                originSelect[i] = new Option(stationName, stationId)
            })

            /* Add options to train number input */

            const trainNumberResults = db.exec("SELECT DISTINCT train_number FROM arrival")
            const trainNumbers = trainNumberResults[0].values
            const trainNumberOptions = [["*", "any"], ...trainNumbers]

            const trainNumberSelect = document.getElementById("trainNumber")
            trainNumberOptions.forEach(([trainNumber, trainNumberName], i) => {
                trainNumberSelect[i] = new Option(trainNumberName || trainNumber, trainNumber)
            })

            /* Add event listener to form */

            function handleInputChange() {
                const arrivalStation = document.getElementById("arrivalStation").value
                const originStation = document.getElementById("originStation").value
                const trainNumber = document.getElementById("trainNumber").value

                displayStats(arrivalStation, originStation, trainNumber)
                updateOptions(arrivalStation, originStation, trainNumber)
            }

            function updateOptions (arrivalStation, originStation, trainNumber) {
                if (arrivalStation === "*") {
                    // enable all options
                    const originSelect = document.getElementById("originStation")
                    originSelect.childNodes.forEach((option) => {
                        option.disabled = false
                    })
                    const trainSelect = document.getElementById("trainNumber")
                    trainSelect.childNodes.forEach((option) => {
                        option.disabled = false
                    })
                    return
                }

                // Restrict origin station options for this arrival station
                const originResults = db.exec(`
                    SELECT DISTINCT origin_id
                    FROM arrival
                    WHERE station_id = ${arrivalStation}
                `)
                const origins = originResults[0].values.map(([value]) => value)
                const originOptions = new Set(["*", ...origins])

                const originSelect = document.getElementById("originStation")
                originSelect.childNodes.forEach((option) => {
                    option.disabled = !originOptions.has(Number(option.value))
                })

                // Reset origin if current option is now disabled
                if (originSelect.selectedOptions[0].disabled) {
                    originSelect.value = "*"
                }
                
                // Restrict train number options for this arrival and origin station
                const originFilter = originStation === "*"
                    ? `true`
                    : `origin_id = ${originStation}`

                const trainNumberResults = db.exec(`
                    SELECT DISTINCT train_number
                    FROM arrival
                    WHERE station_id = ${arrivalStation}
                        AND ${originFilter}
                `)

                const trainNumbers = trainNumberResults[0].values.map(([value]) => value)
                const trainNumberOptions = new Set(["*", ...trainNumbers])

                const trainNumberSelect = document.getElementById("trainNumber")
                trainNumberSelect.childNodes.forEach((option) => {
                    option.disabled = !trainNumberOptions.has(Number(option.value))
                })
                // Reset train number if current option is now disabled
                if (trainNumberSelect.selectedOptions[0].disabled) {
                    trainNumberSelect.value = "*"
                }
            }

            function displayStats (arrivalStation = "*", originStation = "*", trainNumber = "*") {

                const stationFilter = arrivalStation === "*"
                    ? `true`
                    : `station_id = ${arrivalStation}`
                const originFilter = originStation === "*"
                    ? `true`
                    : `origin_id = ${originStation}`
                const trainFilter = trainNumber === "*"
                    ? `true`
                    : `train_number = ${trainNumber}`

                const filters = [stationFilter, originFilter, trainFilter].join(" AND ")

                const queries = {
                    plus15: `SELECT count(*) FROM arrival WHERE (actual_time - scheduled_time) > 15 AND ${filters}`,
                    plus60: `SELECT count(*) FROM arrival WHERE (actual_time - scheduled_time) > 60 AND ${filters}`,
                    total: `SELECT count(*) AS total FROM arrival WHERE ${filters}`,
                    dateRange: `SELECT max(date), min(date) FROM arrival WHERE ${filters}`
                }

                const results = {}

                for (const query in queries) {
                    const [{ values }] = db.exec(queries[query])
                    const [result] = values
                    results[query] = result
                }

                const { plus15, plus60, total, dateRange } = results

                const message = `
                    Since ${dateRange[0]}<br>
                    trains arrived <strong>15 minutes late</strong> ${plus15} times;<br>
                    trains arrived <strong>more than 1 hour late</strong> ${plus60} times;<br>
                    (out of ${total} total trains)
                `

                const el = document.createElement("div")
                el.innerHTML = message
                document.body.appendChild(el)
            }

            document.getElementById("criteria").addEventListener('change', e => handleInputChange())

            /* Add initial data to page */

            displayStats()
        </script>
    </body>
</html>
